{"version":3,"file":"snapshotManager.js","sourceRoot":"","sources":["../../src/matchers/snapshotManager.ts"],"names":[],"mappings":";AAAA;;;;;GAKG;;;;;;;;;;;;;;;;;;;;;;;;;;AAEH,uCAAyB;AACzB,2CAA6B;AAkB7B;;;;;GAKG;AACH,MAAa,eAAe;IAC1B;;OAEG;IACH,MAAM,CAAC,eAAe,CAAC,YAAoB;QAIzC,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;QAC3C,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,oBAAoB,CAAC,CAAC;QAC7D,MAAM,YAAY,GAAG,IAAI,CAAC,IAAI,CAC5B,WAAW,EACX,GAAG,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,qBAAqB,CACpD,CAAC;QACF,OAAO,EAAC,GAAG,EAAE,WAAW,EAAE,IAAI,EAAE,YAAY,EAAC,CAAC;IAChD,CAAC;IAED;;OAEG;IACH,MAAM,CAAC,IAAI,CAAC,gBAAwB;QAClC,IAAI,EAAE,CAAC,UAAU,CAAC,gBAAgB,CAAC,EAAE;YACnC,MAAM,OAAO,GAAG,EAAE,CAAC,YAAY,CAAC,gBAAgB,EAAE,OAAO,CAAC,CAAC;YAC3D,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAiB,CAAC;YACnD,+DAA+D;YAC/D,KAAK,MAAM,KAAK,IAAI,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE;gBACzC,IAAI,KAAK,CAAC,SAAS,IAAI,KAAK,CAAC,SAAS,CAAC,WAAW,KAAK,IAAI,EAAE;oBAC1D,KAAK,CAAC,SAAmC,CAAC,WAAW,GAAG,QAAQ,CAAC;iBACnE;aACF;YACD,OAAO,MAAM,CAAC;SACf;QACD,OAAO,EAAE,CAAC;IACZ,CAAC;IAED;;;OAGG;IACH,MAAM,CAAC,IAAI,CACT,gBAAwB,EACxB,SAAuB;QAEvB,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAC3C,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;YACvB,EAAE,CAAC,SAAS,CAAC,GAAG,EAAE,EAAC,SAAS,EAAE,IAAI,EAAC,CAAC,CAAC;SACtC;QACD,EAAE,CAAC,aAAa,CACd,gBAAgB,EAChB,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC,GAAG,IAAI,EACzC,OAAO,CACR,CAAC;IACJ,CAAC;IAED;;;OAGG;IACH,MAAM,CAAC,QAAQ,CAAC,QAAgB;QAC9B,OAAO,GAAG,QAAQ,IAAI,CAAC;IACzB,CAAC;CACF;AA7DD,0CA6DC","sourcesContent":["/**\r\n * Copyright (c) Microsoft Corporation.\r\n * Licensed under the MIT License.\r\n *\r\n * @format\r\n */\r\n\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\nimport type {PerfMetrics} from '../interfaces/PerfMetrics';\r\nimport type {PerfThreshold} from '../interfaces/PerfThreshold';\r\n\r\n/**\r\n * A single entry stored in a `.perf-baseline.json` file.\r\n */\r\nexport interface SnapshotEntry {\r\n  metrics: PerfMetrics;\r\n  threshold: PerfThreshold;\r\n  capturedAt: string;\r\n}\r\n\r\n/**\r\n * A map of snapshot key → entry, representing one `.perf-baseline.json` file.\r\n */\r\nexport type SnapshotFile = Record<string, SnapshotEntry>;\r\n\r\n/**\r\n * Manages reading and writing of perf snapshot files.\r\n *\r\n * Snapshot files live in `__perf_snapshots__/` adjacent to the test file\r\n * and are committed to git, mirroring Jest's visual snapshot pattern.\r\n */\r\nexport class SnapshotManager {\r\n  /**\r\n   * Resolve the snapshot directory and file path for a given test file.\r\n   */\r\n  static getSnapshotPath(testFilePath: string): {\r\n    dir: string;\r\n    file: string;\r\n  } {\r\n    const testDir = path.dirname(testFilePath);\r\n    const snapshotDir = path.join(testDir, '__perf_snapshots__');\r\n    const snapshotFile = path.join(\r\n      snapshotDir,\r\n      `${path.basename(testFilePath)}.perf-baseline.json`,\r\n    );\r\n    return {dir: snapshotDir, file: snapshotFile};\r\n  }\r\n\r\n  /**\r\n   * Load an existing snapshot file, or return an empty object.\r\n   */\r\n  static load(snapshotFilePath: string): SnapshotFile {\r\n    if (fs.existsSync(snapshotFilePath)) {\r\n      const content = fs.readFileSync(snapshotFilePath, 'utf-8');\r\n      const parsed = JSON.parse(content) as SnapshotFile;\r\n      // JSON.stringify turns Infinity into null — restore it on load\r\n      for (const entry of Object.values(parsed)) {\r\n        if (entry.threshold && entry.threshold.maxDuration === null) {\r\n          (entry.threshold as {maxDuration: number}).maxDuration = Infinity;\r\n        }\r\n      }\r\n      return parsed;\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Save a snapshot file to disk.\r\n   * Creates the directory if it doesn't exist.\r\n   */\r\n  static save(\r\n    snapshotFilePath: string,\r\n    snapshots: SnapshotFile,\r\n  ): void {\r\n    const dir = path.dirname(snapshotFilePath);\r\n    if (!fs.existsSync(dir)) {\r\n      fs.mkdirSync(dir, {recursive: true});\r\n    }\r\n    fs.writeFileSync(\r\n      snapshotFilePath,\r\n      JSON.stringify(snapshots, null, 2) + '\\n',\r\n      'utf-8',\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Build a snapshot key from the test name.\r\n   * Follows Jest's `\"test name 1\"` convention.\r\n   */\r\n  static buildKey(testName: string): string {\r\n    return `${testName} 1`;\r\n  }\r\n}\r\n"]}