{"version":3,"file":"toMatchPerfSnapshot.js","sourceRoot":"","sources":["../../src/matchers/toMatchPerfSnapshot.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Copyright (c) Microsoft Corporation.\r\n * Licensed under the MIT License.\r\n *\r\n * @format\r\n */\r\n\r\nimport type {PerfMetrics} from '../interfaces/PerfMetrics';\r\nimport type {PerfThreshold} from '../interfaces/PerfThreshold';\r\nimport {DEFAULT_THRESHOLD} from '../interfaces/PerfThreshold';\r\nimport {SnapshotManager} from './snapshotManager';\r\n\r\n/**\r\n * Extend Jest's Matchers interface so `toMatchPerfSnapshot` is recognized.\r\n */\r\ndeclare global {\r\n  // eslint-disable-next-line @typescript-eslint/no-namespace\r\n  namespace jest {\r\n    interface Matchers<R> {\r\n      toMatchPerfSnapshot(threshold?: Partial<PerfThreshold>): R;\r\n    }\r\n  }\r\n}\r\n\r\nexpect.extend({\r\n  /**\r\n   * Jest matcher that compares PerfMetrics against a stored baseline.\r\n   *\r\n   * On first run (or with `-u` flag), the baseline is written to a\r\n   * `.perf.snap` file inside `__perf_snapshots__/`.\r\n   *\r\n   * On subsequent runs, it compares the new metrics against the baseline\r\n   * and fails if any threshold is exceeded.\r\n   *\r\n   * @param received - The PerfMetrics from the current test run.\r\n   * @param customThreshold - Optional per-test threshold overrides.\r\n   *\r\n   * @example\r\n   * ```typescript\r\n   * const perf = await viewPerfTest.measureMount();\r\n   * expect(perf).toMatchPerfSnapshot();\r\n   *\r\n   * // With a relaxed threshold:\r\n   * expect(perf).toMatchPerfSnapshot({ maxDurationIncrease: 20 });\r\n   * ```\r\n   */\r\n  toMatchPerfSnapshot(\r\n    received: PerfMetrics,\r\n    customThreshold?: Partial<PerfThreshold>,\r\n  ) {\r\n    const testPath = expect.getState().testPath!;\r\n    const testName = expect.getState().currentTestName!;\r\n\r\n    // Resolve snapshot file location\r\n    const {file: snapshotFile} =\r\n      SnapshotManager.getSnapshotPath(testPath);\r\n    const snapshotKey = SnapshotManager.buildKey(testName);\r\n\r\n    const isUpdateMode =\r\n      process.argv.includes('-u') ||\r\n      process.argv.includes('--updateSnapshot');\r\n\r\n    // Load existing snapshots\r\n    const snapshots = SnapshotManager.load(snapshotFile);\r\n    const baseline = snapshots[snapshotKey];\r\n\r\n    const threshold: PerfThreshold = {...DEFAULT_THRESHOLD, ...customThreshold};\r\n\r\n    // â”€â”€â”€ UPDATE MODE or FIRST RUN: write new baseline â”€â”€â”€\r\n    if (isUpdateMode || !baseline) {\r\n      snapshots[snapshotKey] = {\r\n        metrics: received,\r\n        threshold,\r\n        capturedAt: new Date().toISOString(),\r\n      };\r\n\r\n      SnapshotManager.save(snapshotFile, snapshots);\r\n\r\n      return {\r\n        pass: true,\r\n        message: () =>\r\n          `âœ… Perf snapshot ${baseline ? 'updated' : 'created'}: ${received.name}` +\r\n          ` (${received.meanDuration.toFixed(2)}ms, ${received.renderCount} renders)`,\r\n      };\r\n    }\r\n\r\n    // â”€â”€â”€ COMPARE MODE: check against baseline â”€â”€â”€\r\n    const errors: string[] = [];\r\n\r\n    // Check duration regression using MEDIAN (robust to outlier spikes)\r\n    if (threshold.maxDurationIncrease !== undefined) {\r\n      const percentChange =\r\n        ((received.medianDuration - baseline.metrics.medianDuration) /\r\n          baseline.metrics.medianDuration) *\r\n        100;\r\n\r\n      const absoluteDelta = received.medianDuration - baseline.metrics.medianDuration;\r\n      const minAbsoluteDelta = threshold.minAbsoluteDelta ?? DEFAULT_THRESHOLD.minAbsoluteDelta;\r\n\r\n      if (percentChange > threshold.maxDurationIncrease && absoluteDelta > minAbsoluteDelta) {\r\n        errors.push(\r\n          `Duration regression: +${percentChange.toFixed(1)}% / +${absoluteDelta.toFixed(2)}ms ` +\r\n            `(baseline median: ${baseline.metrics.medianDuration.toFixed(2)}ms â†’ ` +\r\n            `current median: ${received.medianDuration.toFixed(2)}ms, ` +\r\n            `threshold: ${threshold.maxDurationIncrease}% & ${minAbsoluteDelta}ms)`,\r\n        );\r\n      }\r\n    }\r\n\r\n    // Check absolute duration limit (use median for consistency)\r\n    if (\r\n      threshold.maxDuration !== undefined &&\r\n      threshold.maxDuration !== Infinity &&\r\n      received.medianDuration > threshold.maxDuration\r\n    ) {\r\n      errors.push(\r\n        `Duration exceeded: ${received.medianDuration.toFixed(2)}ms > ` +\r\n          `${threshold.maxDuration}ms (absolute limit)`,\r\n      );\r\n    }\r\n\r\n    // Check render count\r\n    if (\r\n      threshold.maxRenderCount !== undefined &&\r\n      received.renderCount > threshold.maxRenderCount\r\n    ) {\r\n      errors.push(\r\n        `Render count exceeded: ${received.renderCount} > ` +\r\n          `${threshold.maxRenderCount}`,\r\n      );\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n      return {\r\n        pass: false,\r\n        message: () =>\r\n          `âŒ Performance regression detected in \"${received.name}\":\\n\\n` +\r\n          errors.map(e => `  â€¢ ${e}`).join('\\n') +\r\n          `\\n\\nðŸ“Š Baseline captured: ${baseline.capturedAt}` +\r\n          `\\nðŸ’¡ Run with -u flag to update baseline if intentional.`,\r\n      };\r\n    }\r\n\r\n    // Calculate improvement for positive feedback\r\n    const improvement =\r\n      ((baseline.metrics.medianDuration - received.medianDuration) /\r\n        baseline.metrics.medianDuration) *\r\n      100;\r\n\r\n    return {\r\n      pass: true,\r\n      message: () =>\r\n        `âœ… \"${received.name}\" within threshold ` +\r\n        `(median: ${received.medianDuration.toFixed(2)}ms, ` +\r\n        `${improvement > 0 ? `-${improvement.toFixed(1)}% faster` : 'no change'})`,\r\n    };\r\n  },\r\n});\r\n"]}