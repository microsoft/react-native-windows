{"version":3,"file":"BaselineComparator.js","sourceRoot":"","sources":["../../src/ci/BaselineComparator.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Copyright (c) Microsoft Corporation.\r\n * Licensed under the MIT License.\r\n *\r\n * Compares current perf results against stored baselines.\r\n * Used in CI to detect regressions and generate comparison reports.\r\n *\r\n * @format\r\n */\r\n\r\nimport type {PerfMetrics} from '../interfaces/PerfMetrics';\r\nimport type {PerfThreshold} from '../interfaces/PerfThreshold';\r\nimport {DEFAULT_THRESHOLD} from '../interfaces/PerfThreshold';\r\nimport type {SnapshotFile} from '../matchers/snapshotManager';\r\nimport type {ComparisonResult} from '../reporters/MarkdownReporter';\r\n\r\n/**\r\n * Options for baseline comparison.\r\n */\r\nexport interface CompareOptions {\r\n  /**\r\n   * Default threshold applied when a snapshot entry has none.\r\n   */\r\n  defaultThreshold?: PerfThreshold;\r\n\r\n  /**\r\n   * Per-scenario threshold overrides, keyed by snapshot key.\r\n   */\r\n  thresholdOverrides?: Record<string, Partial<PerfThreshold>>;\r\n}\r\n\r\n/**\r\n * Full comparison output for a test suite.\r\n */\r\nexport interface SuiteComparison {\r\n  suiteName: string;\r\n  comparisons: ComparisonResult[];\r\n  hasRegressions: boolean;\r\n}\r\n\r\n/**\r\n * Compares head (current) perf snapshots against base (main) snapshots.\r\n *\r\n * Produces ComparisonResult[] that can be fed into MarkdownReporter.\r\n */\r\nexport class BaselineComparator {\r\n  /**\r\n   * Compare a single suite's head snapshot against its baseline.\r\n   *\r\n   * @param suiteName - Human-readable suite name (e.g., 'View')\r\n   * @param headSnapshots - Snapshots from the current (PR) run\r\n   * @param baseSnapshots - Snapshots from the baseline (main) branch\r\n   * @param options - Comparison options\r\n   */\r\n  static compareSuite(\r\n    suiteName: string,\r\n    headSnapshots: SnapshotFile,\r\n    baseSnapshots: SnapshotFile,\r\n    options: CompareOptions = {},\r\n  ): SuiteComparison {\r\n    const defaultThreshold = options.defaultThreshold || DEFAULT_THRESHOLD;\r\n    const comparisons: ComparisonResult[] = [];\r\n\r\n    // Compare all entries present in head\r\n    for (const [key, headEntry] of Object.entries(headSnapshots)) {\r\n      const baseEntry = baseSnapshots[key];\r\n      const threshold = {\r\n        ...defaultThreshold,\r\n        ...(headEntry.threshold || {}),\r\n        ...(options.thresholdOverrides?.[key] || {}),\r\n      };\r\n\r\n      if (!baseEntry) {\r\n        // New scenario â€” no baseline to compare\r\n        comparisons.push({\r\n          metrics: headEntry.metrics,\r\n          baselineMetrics: undefined,\r\n          percentChange: undefined,\r\n          passed: true, // New scenarios always pass\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const result = BaselineComparator.compareEntry(\r\n        headEntry.metrics,\r\n        baseEntry.metrics,\r\n        threshold,\r\n      );\r\n      comparisons.push(result);\r\n    }\r\n\r\n    // Flag scenarios removed in head (existed in base but not in head)\r\n    for (const key of Object.keys(baseSnapshots)) {\r\n      if (!headSnapshots[key]) {\r\n        comparisons.push({\r\n          metrics: {\r\n            ...baseSnapshots[key].metrics,\r\n            name: `[REMOVED] ${baseSnapshots[key].metrics.name}`,\r\n          },\r\n          baselineMetrics: baseSnapshots[key].metrics,\r\n          percentChange: undefined,\r\n          passed: true, // Removal is not a regression\r\n        });\r\n      }\r\n    }\r\n\r\n    return {\r\n      suiteName,\r\n      comparisons,\r\n      hasRegressions: comparisons.some(c => !c.passed),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Compare a single entry's metrics against its baseline.\r\n   */\r\n  static compareEntry(\r\n    head: PerfMetrics,\r\n    base: PerfMetrics,\r\n    threshold: PerfThreshold,\r\n  ): ComparisonResult {\r\n    // Merge with defaults so all fields are guaranteed defined\r\n    const resolved: Required<PerfThreshold> = {\r\n      ...DEFAULT_THRESHOLD,\r\n      ...threshold,\r\n    };\r\n\r\n    const percentChange =\r\n      base.meanDuration > 0\r\n        ? ((head.meanDuration - base.meanDuration) / base.meanDuration) * 100\r\n        : 0;\r\n\r\n    const errors: string[] = [];\r\n\r\n    // Check percentage increase\r\n    if (percentChange > resolved.maxDurationIncrease) {\r\n      errors.push(\r\n        `Duration increased by ${percentChange.toFixed(1)}% ` +\r\n          `(threshold: ${resolved.maxDurationIncrease}%)`,\r\n      );\r\n    }\r\n\r\n    // Check absolute max\r\n    if (head.meanDuration > resolved.maxDuration) {\r\n      errors.push(\r\n        `Duration ${head.meanDuration.toFixed(2)}ms exceeds ` +\r\n          `max ${resolved.maxDuration}ms`,\r\n      );\r\n    }\r\n\r\n    // Check render count\r\n    if (head.renderCount > resolved.maxRenderCount) {\r\n      errors.push(\r\n        `Render count ${head.renderCount} exceeds ` +\r\n          `max ${resolved.maxRenderCount}`,\r\n      );\r\n    }\r\n\r\n    return {\r\n      metrics: head,\r\n      baselineMetrics: base,\r\n      percentChange,\r\n      passed: errors.length === 0,\r\n      error: errors.length > 0 ? errors.join('; ') : undefined,\r\n    };\r\n  }\r\n}\r\n"]}