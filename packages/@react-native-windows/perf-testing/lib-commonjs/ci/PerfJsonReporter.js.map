{"version":3,"file":"PerfJsonReporter.js","sourceRoot":"","sources":["../../src/ci/PerfJsonReporter.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Copyright (c) Microsoft Corporation.\r\n * Licensed under the MIT License.\r\n *\r\n * Custom Jest reporter that writes perf results to a JSON file.\r\n * Used in CI to produce machine-readable output for downstream comparison\r\n * and PR comment generation.\r\n *\r\n * @format\r\n */\r\n\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\nimport {SnapshotManager} from '../matchers/snapshotManager';\r\nimport type {SnapshotFile} from '../matchers/snapshotManager';\r\n\r\n/**\r\n * Summary of a single test suite's perf results.\r\n */\r\nexport interface SuiteResult {\r\n  testFilePath: string;\r\n  suiteName: string;\r\n  snapshots: SnapshotFile;\r\n  passed: number;\r\n  failed: number;\r\n  totalDuration: number;\r\n}\r\n\r\n/**\r\n * Full CI perf run results.\r\n */\r\nexport interface CIRunResults {\r\n  timestamp: string;\r\n  branch: string;\r\n  commitSha: string;\r\n  suites: SuiteResult[];\r\n  summary: {\r\n    totalSuites: number;\r\n    totalTests: number;\r\n    passed: number;\r\n    failed: number;\r\n    durationMs: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Custom Jest reporter that collects all perf snapshot data\r\n * after tests complete and writes a single JSON results file.\r\n *\r\n * Add to jest config:\r\n * ```js\r\n * reporters: [\r\n *   'default',\r\n *   ['@react-native-windows/perf-testing/lib-commonjs/ci/PerfJsonReporter', {\r\n *     outputFile: '.perf-results/results.json'\r\n *   }]\r\n * ]\r\n * ```\r\n */\r\nexport class PerfJsonReporter {\r\n  private outputFile: string;\r\n\r\n  constructor(\r\n    _globalConfig: Record<string, unknown>,\r\n    options: {outputFile?: string} = {},\r\n  ) {\r\n    this.outputFile = options.outputFile || '.perf-results/results.json';\r\n  }\r\n\r\n  /**\r\n   * Called by Jest after all test suites have completed.\r\n   */\r\n  onRunComplete(\r\n    _testContexts: Set<unknown>,\r\n    results: {\r\n      numTotalTestSuites: number;\r\n      numPassedTestSuites: number;\r\n      numFailedTestSuites: number;\r\n      numTotalTests: number;\r\n      numPassedTests: number;\r\n      numFailedTests: number;\r\n      startTime: number;\r\n      testResults: Array<{\r\n        testFilePath: string;\r\n        testResults: Array<{\r\n          ancestorTitles: string[];\r\n          title: string;\r\n          status: string;\r\n          duration?: number;\r\n        }>;\r\n        perfTimer?: {start: number; end: number};\r\n      }>;\r\n    },\r\n  ): void {\r\n    const suites: SuiteResult[] = [];\r\n\r\n    for (const suite of results.testResults) {\r\n      // Load the snapshot file for this test suite (written by toMatchPerfSnapshot)\r\n      const {file: snapshotFilePath} = SnapshotManager.getSnapshotPath(\r\n        suite.testFilePath,\r\n      );\r\n      const snapshots = SnapshotManager.load(snapshotFilePath);\r\n\r\n      const passed = suite.testResults.filter(\r\n        t => t.status === 'passed',\r\n      ).length;\r\n      const failed = suite.testResults.filter(\r\n        t => t.status === 'failed',\r\n      ).length;\r\n      const totalDuration = suite.testResults.reduce(\r\n        (acc, t) => acc + (t.duration || 0),\r\n        0,\r\n      );\r\n\r\n      suites.push({\r\n        testFilePath: suite.testFilePath,\r\n        suiteName: path.basename(suite.testFilePath, '.perf-test.tsx'),\r\n        snapshots,\r\n        passed,\r\n        failed,\r\n        totalDuration,\r\n      });\r\n    }\r\n\r\n    const ciResults: CIRunResults = {\r\n      timestamp: new Date().toISOString(),\r\n      branch: process.env.BUILD_SOURCEBRANCH ||\r\n        process.env.GITHUB_HEAD_REF ||\r\n        process.env.GITHUB_REF ||\r\n        'unknown',\r\n      commitSha: process.env.BUILD_SOURCEVERSION ||\r\n        process.env.GITHUB_SHA ||\r\n        'unknown',\r\n      suites,\r\n      summary: {\r\n        totalSuites: results.numTotalTestSuites,\r\n        totalTests: results.numTotalTests,\r\n        passed: results.numPassedTests,\r\n        failed: results.numFailedTests,\r\n        durationMs: Date.now() - results.startTime,\r\n      },\r\n    };\r\n\r\n    // Write results\r\n    const outputDir = path.dirname(this.outputFile);\r\n    if (!fs.existsSync(outputDir)) {\r\n      fs.mkdirSync(outputDir, {recursive: true});\r\n    }\r\n    fs.writeFileSync(\r\n      this.outputFile,\r\n      JSON.stringify(ciResults, null, 2) + '\\n',\r\n      'utf-8',\r\n    );\r\n\r\n    console.log(`\\nðŸ“Š Perf results written to: ${this.outputFile}`);\r\n  }\r\n}\r\n\r\n// Default export for Jest reporter compatibility\r\nmodule.exports = PerfJsonReporter;\r\n"]}