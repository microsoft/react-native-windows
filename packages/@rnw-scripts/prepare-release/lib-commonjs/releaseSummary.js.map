{"version":3,"file":"releaseSummary.js","sourceRoot":"","sources":["../src/releaseSummary.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n * Licensed under the MIT License.\n *\n * Parse bumped packages and generate PR description markdown.\n *\n * @format\n */\n\nimport fs from 'fs';\nimport path from 'path';\n\nexport interface BumpedPackage {\n  name: string;\n  version: string;\n  comments: Array<{comment: string; author: string}>;\n}\n\n/**\n * Collect information about packages that were bumped by beachball.\n *\n * For each changed package.json, reads the new version and parses\n * CHANGELOG.json for the latest changelog entry.\n *\n * @param changedPackageJsonPaths Relative paths to package.json files\n *   that were modified by beachball bump (from git status --porcelain)\n * @param repoRoot The repository root directory\n */\nexport function collectBumpedPackages(\n  changedPackageJsonPaths: string[],\n  repoRoot: string,\n): BumpedPackage[] {\n  const bumped: BumpedPackage[] = [];\n\n  for (const relPath of changedPackageJsonPaths) {\n    const fullPath = path.join(repoRoot, relPath);\n    if (!fs.existsSync(fullPath)) {\n      continue;\n    }\n\n    let pkgJson: {name?: string; version?: string};\n    try {\n      pkgJson = JSON.parse(fs.readFileSync(fullPath, 'utf8'));\n    } catch {\n      continue;\n    }\n\n    const name = pkgJson.name;\n    const version = pkgJson.version;\n    if (!name || !version) {\n      continue;\n    }\n\n    // Try to read CHANGELOG.json from the same directory\n    const pkgDir = path.dirname(fullPath);\n    const changelogPath = path.join(pkgDir, 'CHANGELOG.json');\n    const comments: Array<{comment: string; author: string}> = [];\n\n    if (fs.existsSync(changelogPath)) {\n      try {\n        const changelog = JSON.parse(\n          fs.readFileSync(changelogPath, 'utf8'),\n        );\n\n        // CHANGELOG.json structure:\n        // { entries: [{ version, comments: { <changeType>: [{ comment, author }] } }] }\n        const latest = changelog.entries?.[0];\n        if (latest && latest.version === version) {\n          for (const typeComments of Object.values(\n            latest.comments || {},\n          )) {\n            for (const c of typeComments as Array<{\n              comment: string;\n              author: string;\n            }>) {\n              comments.push({\n                comment: c.comment || '',\n                author: c.author || '',\n              });\n            }\n          }\n        }\n      } catch {\n        // If CHANGELOG.json is malformed, skip comments\n      }\n    }\n\n    bumped.push({name, version, comments});\n  }\n\n  // Sort by package name for consistent output\n  bumped.sort((a, b) => a.name.localeCompare(b.name));\n  return bumped;\n}\n\n/**\n * Generate the pull request body markdown.\n */\nexport function generatePRBody(\n  targetBranch: string,\n  packages: BumpedPackage[],\n): string {\n  const lines: string[] = [];\n\n  lines.push('> This PR was auto-generated by `prepare-release`.');\n  lines.push(\n    `> When ready to release, merge this PR into \\`${targetBranch}\\`.`,\n  );\n  lines.push(\n    '> If not ready yet, this PR will be updated as more changes merge.',\n  );\n  lines.push('');\n  lines.push(`## Packages to Release (${packages.length})`);\n  lines.push('');\n\n  for (const pkg of packages) {\n    lines.push(`### ${pkg.name}@${pkg.version}`);\n    if (pkg.comments.length > 0) {\n      for (const c of pkg.comments) {\n        lines.push(`- ${c.comment}`);\n      }\n    } else {\n      lines.push('- *(dependency update)*');\n    }\n    lines.push('');\n  }\n\n  return lines.join('\\n');\n}\n\n/**\n * Generate a console-friendly summary of bumped packages.\n */\nexport function generateConsoleSummary(packages: BumpedPackage[]): string {\n  if (packages.length === 0) {\n    return 'No packages were bumped.';\n  }\n\n  const lines: string[] = [];\n  lines.push(`Bumped ${packages.length} package(s):`);\n  for (const pkg of packages) {\n    lines.push(`  ${pkg.name} => ${pkg.version}`);\n  }\n  return lines.join('\\n');\n}\n"]}