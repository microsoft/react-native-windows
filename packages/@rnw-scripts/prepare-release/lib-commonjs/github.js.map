{"version":3,"file":"github.js","sourceRoot":"","sources":["../src/github.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n * Licensed under the MIT License.\n *\n * GitHub operations via the gh CLI.\n *\n * @format\n */\n\nimport fs from 'fs';\nimport os from 'os';\nimport path from 'path';\n\nimport {exec} from './proc';\n\nexport interface PRInfo {\n  number: number;\n  url: string;\n}\n\n/**\n * Run a callback with a temporary file containing the given content.\n * The file is cleaned up after the callback completes (success or failure).\n */\nasync function withTempFile<T>(\n  content: string,\n  fn: (filePath: string) => Promise<T>,\n): Promise<T> {\n  const tmpFile = path.join(\n    os.tmpdir(),\n    `gh-pr-body-${process.pid}-${Date.now()}.md`,\n  );\n  fs.writeFileSync(tmpFile, content, 'utf8');\n  try {\n    return await fn(tmpFile);\n  } finally {\n    try {\n      fs.unlinkSync(tmpFile);\n    } catch {\n      // Ignore cleanup errors\n    }\n  }\n}\n\n/**\n * Find an existing open PR by head branch name.\n * Returns null if no matching PR exists.\n */\nexport async function findPR(opts: {\n  head: string;\n  cwd: string;\n  repo?: string;\n}): Promise<PRInfo | null> {\n  const repoFlag = opts.repo ? ` --repo \"${opts.repo}\"` : '';\n  const result = await exec(\n    `gh pr list --head \"${opts.head}\" --json number,url --limit 1${repoFlag}`,\n    {cwd: opts.cwd, fallback: '[]'},\n  );\n\n  let prs: Array<{number: number; url: string}>;\n  try {\n    prs = JSON.parse(result);\n  } catch {\n    return null;\n  }\n\n  if (!Array.isArray(prs) || prs.length === 0) {\n    return null;\n  }\n\n  return {number: prs[0].number, url: prs[0].url};\n}\n\n/**\n * Create a new pull request. Returns the PR number and URL.\n *\n * Uses --body-file with a temp file to avoid shell escaping issues\n * with multiline markdown content on Windows cmd.exe.\n */\nexport async function createPR(opts: {\n  head: string;\n  base: string;\n  title: string;\n  body: string;\n  cwd: string;\n  repo?: string;\n}): Promise<PRInfo> {\n  return withTempFile(opts.body, async bodyFile => {\n    const repoFlag = opts.repo ? ` --repo \"${opts.repo}\"` : '';\n    const result = await exec(\n      `gh pr create --head \"${opts.head}\" --base \"${opts.base}\"` +\n        ` --title \"${escapeForShell(opts.title)}\"` +\n        ` --body-file \"${bodyFile}\"${repoFlag}`,\n      {cwd: opts.cwd},\n    );\n\n    // gh pr create outputs the PR URL on success\n    const url = result.trim();\n    const match = url.match(/\\/pull\\/(\\d+)/);\n    const number = match ? parseInt(match[1], 10) : 0;\n\n    return {number, url};\n  });\n}\n\n/**\n * Update an existing pull request's body text.\n *\n * Uses --body-file with a temp file to avoid shell escaping issues\n * with multiline markdown content on Windows cmd.exe.\n */\nexport async function updatePR(opts: {\n  number: number;\n  body: string;\n  cwd: string;\n  repo?: string;\n}): Promise<void> {\n  await withTempFile(opts.body, async bodyFile => {\n    const repoFlag = opts.repo ? ` --repo \"${opts.repo}\"` : '';\n    await exec(\n      `gh pr edit ${opts.number} --body-file \"${bodyFile}\"${repoFlag}`,\n      {cwd: opts.cwd},\n    );\n  });\n}\n\n/**\n * Escape a string for safe inclusion in a double-quoted shell argument.\n * Used for single-line values like titles; multiline content uses --body-file.\n */\nfunction escapeForShell(str: string): string {\n  return str\n    .replace(/\\\\/g, '\\\\\\\\')\n    .replace(/\"/g, '\\\\\"')\n    .replace(/\\$/g, '\\\\$')\n    .replace(/`/g, '\\\\`');\n}\n"]}