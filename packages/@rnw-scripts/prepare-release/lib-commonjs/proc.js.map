{"version":3,"file":"proc.js","sourceRoot":"","sources":["../src/proc.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n * Licensed under the MIT License.\n *\n * Async wrapper around Node.js child_process.spawn.\n * Simplified from fork-sync/src/modules/proc.ts.\n *\n * @format\n */\n\nimport {spawn as nodeSpawn} from 'child_process';\n\n/**\n * Error thrown when a spawned process exits with a non-zero code.\n */\nexport class ExecError extends Error {\n  readonly command: string;\n  readonly args: readonly string[];\n  readonly cwd: string | undefined;\n  readonly exitCode: number | null;\n  readonly stderr: string;\n\n  constructor(opts: {\n    command: string;\n    args: readonly string[];\n    cwd?: string;\n    exitCode: number | null;\n    stderr: string;\n  }) {\n    const cmdStr = [opts.command, ...opts.args].join(' ');\n    super(\n      opts.stderr ||\n        `Command failed with exit code ${opts.exitCode}: ${cmdStr}`,\n    );\n    this.name = 'ExecError';\n    this.command = opts.command;\n    this.args = opts.args;\n    this.cwd = opts.cwd;\n    this.exitCode = opts.exitCode;\n    this.stderr = opts.stderr;\n  }\n}\n\nexport interface SpawnOpts {\n  cwd?: string;\n  /** If set, return this value instead of throwing on non-zero exit */\n  fallback?: string;\n  /** Extra environment variables (merged with process.env) */\n  env?: Record<string, string>;\n}\n\n/**\n * Spawn a command (no shell) and return its trimmed stdout.\n * Throws ExecError on non-zero exit unless `fallback` is provided.\n */\nexport function spawn(\n  command: string,\n  args: readonly string[],\n  opts?: SpawnOpts,\n): Promise<string> {\n  return spawnImpl(command, [...args], opts, false);\n}\n\n/**\n * Execute a command string in a shell and return its trimmed stdout.\n * Uses shell mode, needed for .cmd shims on Windows (npx, gh).\n */\nexport function exec(command: string, opts?: SpawnOpts): Promise<string> {\n  return spawnImpl(command, [], opts, true);\n}\n\nfunction spawnImpl(\n  command: string,\n  args: string[],\n  opts: SpawnOpts | undefined,\n  shell: boolean,\n): Promise<string> {\n  return new Promise<string>((resolve, reject) => {\n    const child = nodeSpawn(command, args, {\n      cwd: opts?.cwd,\n      env: opts?.env ? {...process.env, ...opts.env} : undefined,\n      stdio: ['ignore', 'pipe', 'pipe'],\n      windowsHide: true,\n      shell,\n    });\n\n    const stdoutChunks: Buffer[] = [];\n    const stderrChunks: Buffer[] = [];\n\n    child.stdout!.on('data', (chunk: Buffer) => stdoutChunks.push(chunk));\n    child.stderr!.on('data', (chunk: Buffer) => stderrChunks.push(chunk));\n\n    child.on('error', err => {\n      reject(err);\n    });\n\n    child.on('close', exitCode => {\n      const stdout = Buffer.concat(stdoutChunks).toString('utf8').trimEnd();\n      const stderr = Buffer.concat(stderrChunks).toString('utf8').trimEnd();\n\n      if (exitCode !== 0) {\n        if (opts?.fallback !== undefined) {\n          resolve(opts.fallback);\n        } else {\n          reject(\n            new ExecError({\n              command,\n              args,\n              cwd: opts?.cwd,\n              exitCode,\n              stderr,\n            }),\n          );\n        }\n      } else {\n        resolve(stdout);\n      }\n    });\n  });\n}\n"]}