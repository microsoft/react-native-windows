<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Use Win32 features from a React Native for Windows application · React Native for Windows</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;head&gt;"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Use Win32 features from a React Native for Windows application · React Native for Windows"/><meta property="og:type" content="website"/><meta property="og:url" content="https://microsoft.github.io/react-native-windows/blog/2021/08/05/win32component"/><meta property="og:description" content="&lt;head&gt;"/><meta property="og:image" content="https://microsoft.github.io/react-native-windows/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://microsoft.github.io/react-native-windows/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/react-native-windows/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"/><link rel="stylesheet" href="/react-native-windows/css/code-block-buttons.css"/><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/focus-visible@5.0.2/dist/focus-visible.min.js"></script><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/react-native-windows/js/code-block-buttons.js"></script><script type="text/javascript" src="/react-native-windows/js/nav-buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/react-native-windows/js/scrollSpy.js"></script><link rel="stylesheet" href="/react-native-windows/css/prism.css"/><link rel="stylesheet" href="/react-native-windows/css/main.css"/><script src="/react-native-windows/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/react-native-windows/"><img class="logo" src="/react-native-windows/img/header_logo.svg" alt="React Native for Windows"/><h2 class="headerTitleWithLogo">React Native for Windows</h2></a><a href="/react-native-windows/versions"><h3>0.79</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/react-native-windows/docs/getting-started" target="_self">Docs</a></li><li class=""><a href="/react-native-windows/docs/flyout-component" target="_self">APIs</a></li><li class=""><a href="https://devblogs.microsoft.com/react-native/" target="_self">Blog</a></li><li class=""><a href="/react-native-windows/resources" target="_self">Resources</a></li><li class=""><a href="https://github.com/microsoft/react-native-windows-samples/tree/main/samples" target="_self">Samples</a></li><li class=""><a href="/react-native-windows/support" target="_self">Support</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Recent Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Recent Posts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/react-native-windows/blog/2022/07/29/coreapp">Streamlining app creation with React Native for Windows CoreApp</a></li><li class="navListItem"><a class="navItem" href="/react-native-windows/blog/2022/02/11/settings">React Native for Windows is helping Settings improve more quickly</a></li><li class="navListItem"><a class="navItem" href="/react-native-windows/blog/2022/02/11/rnwinrt">Calling Windows APIs from React Native just got easier</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/react-native-windows/blog/2021/08/05/win32component">Use Win32 features from a React Native for Windows application</a></li><li class="navListItem"><a class="navItem" href="/react-native-windows/blog/2021/06/30/notifications">Add Toast notifications to your React Native for Windows application</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/react-native-windows/blog/2021/08/05/win32component">Use Win32 features from a React Native for Windows application</a></h1><p class="post-meta">August 5, 2021</p><div class="authorBlock"><p class="post-authorName"><a href="https://twitter.com/qmatteoq" target="_blank" rel="noreferrer noopener">Matteo Pagani</a></p></div></header><div><span><p><head>
<meta http-equiv="Refresh" content="0; URL=https://devblogs.microsoft.com/react-native/win32component/" />
</head></p>
<p>If you have adopted React Native to build your Windows applications, you'll know that the final output is a <a href="https://docs.microsoft.com/windows/uwp/get-started/universal-application-platform-guide">Universal Windows Platform application</a>. This development platform gives you access to all the latest enhancements in the Windows ecosystem (modern UI platform, notifications, integration with features like inking and Windows Hello, etc.), plus greater security and reliability thanks to the sandbox the application runs in.
However, there might be scenarios where UWP isn't enough and you need to perform one or more tasks which are supported only by the Win32 ecosystem: working with any file on the disk without user intervention, reading a key from the registry, integrating a SDK which doesn't support the Windows Runtime.</p>
<p>In this post we're going to explore a solution that will enable you to get the best of both worlds: a React Native for Windows application which integrates a classic Win32 process. We're going to build a sample React Native application which will be able to read a registry key and display it. The goal is to display to the user values stored in the <code>\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion</code> hive, which contains many information about the currently installed version of Windows.</p>
<!--truncate-->
<p>The solution will use the following components.</p>
<h4><a class="anchor" aria-hidden="true" id="a-classic-windows-process"></a><a href="#a-classic-windows-process" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A classic Windows process</h4>
<p>We're going to build a .NET 5.0 console application which, by targeting Windows 10 and using the <a href="https://docs.microsoft.com/dotnet/core/porting/windows-compat-pack">Windows Compatibility Pack</a>, will be able to interact with the system registry. The React Native application will send to this process the name of the key we want to retrieve; the process will read its value and send it back to the React Native application.</p>
<h4><a class="anchor" aria-hidden="true" id="a-react-native-for-windows-application"></a><a href="#a-react-native-for-windows-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A React Native for Windows application</h4>
<p>This will be a traditional React Native for Windows application. However, as we're going to see later, we'll have to make a couple of changes to the host app generated by the template to handle the communication with the classic Windows process.</p>
<h4><a class="anchor" aria-hidden="true" id="app-services"></a><a href="#app-services" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>App Services</h4>
<p><a href="https://docs.microsoft.com/windows/uwp/launch-resume/app-services">App Services</a> is a UWP feature that enables a Windows application to host one or more background tasks that can be consumed by other applications. You can think of this feature like REST services, but exposed locally. Once a UWP application which exposes an App Service is deployed on a machine, other applications can connect to it using its name and the Package Family Name of the hosting application. Once the communication channel is established, the calling application can send data to the App Service, which will process it and send back the results.</p>
<p>In our context, App Service will enable us to create a communication channel between the React Native application and the classic Win32 process. The main difference compared to the traditional usage is that the App Service will be hosted and consumed by the same package, since the two processes (UWP and classic Win32) will be packaged together.</p>
<p>App Services support two approaches: <a href="https://docs.microsoft.com/windows/uwp/launch-resume/convert-app-service-in-process">in-proc</a> (when the implementation of the service is defined in the main application itself) and <a href="https://docs.microsoft.com/windows/uwp/launch-resume/how-to-create-and-consume-an-app-service">out-of-proc</a> (when the implementation of the service is defined in an external Windows Runtime Component, which gets executed in a different process). For our scenario, we must use the in-proc approach, since we need to hold a direct connection with the main application.</p>
<h4><a class="anchor" aria-hidden="true" id="a-native-module"></a><a href="#a-native-module" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A native module</h4>
<p><a href="https://microsoft.github.io/react-native-windows/docs/native-modules">A native module</a> is the way to expose native features to the JavaScript layer of React Native application. In the Windows context, a native module is a Windows Runtime Component that, through attributes which decorates your code, can expose methods, properties and events to JavaScript.
The native module is needed as a glue between the React Native world and the UWP world. All the APIs to interact with an App Service are exposed by the Windows Runtime and, as such, we need a middle man that can make them accessible to JavaScript.</p>
<h4><a class="anchor" aria-hidden="true" id="windows-application-packaging-project"></a><a href="#windows-application-packaging-project" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Windows Application Packaging Project</h4>
<p>A <a href="https://docs.microsoft.com//windows/msix/desktop/desktop-to-uwp-packaging-dot-net">Windows Application Packaging Project</a> (WAP project, from now on) is a template available in Visual Studio, which is typically used to package as MSIX classic Windows application. In our context, we're going to use it to bundle together the classic Win32 process and the React Native for Windows application in the same MSIX package.</p>
<p>The diagram below shows how all these components are tight together:</p>
<p><img src="/react-native-windows/blog/assets/2021-05-08-win32component/architecture.png" alt="The architecture of the solution we're going to build in the article"></p>
<ol>
<li>The user launches the React Native application which, at the same time, starts also the classic Win32 process.</li>
<li>The Win32 process, at startup, establishes a communication with the React Native application using an App Service and it stores a reference to the channel.</li>
<li>The user presses a button in the React Native application.</li>
<li>The button will invoke a method method exposed by the native module. The method will push a message to the communication channel, so that it can be received by the classic Win32 process. The message will contain the information about the key that the Windows process must retrieve from the registry.</li>
<li>The classic Win32 process retrieves the desired key from the registry, it stores it inside another message and it sends it back to the communication channel.</li>
<li>The native module, which is using the App Service to keep the communication channel open, receives the message with the retrieved key and it sends it back to the JavaScript layer.</li>
<li>The React Native application can now show to the user the value of the registry key.</li>
</ol>
<p>Let's start building all the components!</p>
<blockquote>
<p>All the samples you'll find below (including the native module and the React Native host app) will be based on C#, since it's the language I'm most familiar with. However, the same goal can be achieved also using the C++ templates.</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="the-classic-win32-process"></a><a href="#the-classic-win32-process" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The classic Win32 process</h3>
<p>For the purpose of this sample, we're going to use a .NET 5.0 console application. Open with Visual Studio the solution included in the <code>windows</code> folder of your React Native application, right click on it and choose <strong>Add -&gt; New project</strong>. Choose <strong>Console application</strong> as template.</p>
<p>Before starting to write some code, we need to make a few changes:</p>
<ol>
<li>Double click on the project and change the <code>TargetFramework</code> from <code>net5.0</code> to <code>net5.0-windows10.0.19041.0</code>. The new target will enable you to leverage Windows 10 APIs from your .NET application. It's required in our scenario since we need to use the App Service APIs.</li>
<li>Right click on the project, choose <strong>Manage NuGet Packages</strong> and install the <a href="https://www.nuget.org/packages/Microsoft.Windows.Compatibility">Microsoft.Windows.Compatibility</a> package. It will give us access to the APIs to interact with the Windows registry.</li>
<li>Right click on the project, choose <strong>Properties</strong> and change the <strong>Output type</strong> from <strong>Console Application</strong> to <strong>Windows Application</strong>. Thanks to this change, our application will run headless, without any visible UI. This helps to achieve a good user experience, since our classic Win32 process will run only in background. All the UI and interaction will be handled by the React Naive application.</li>
</ol>
<p>The application will run continuously in background, until the main React Native application will be closed. To achieve this goal, we start the main process in a separate thread, which gets terminated when the connection with the App Service is closed (which means that the application is closed). This approach ensures that the classic Win32 application doesn't become a &quot;zombie&quot; process, which stays alive even if the main app has been shut down.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">static</span> <span class="token class-name">AutoResetEvent</span> appServiceExit<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">AppServiceConnection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    appServiceExit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutoResetEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> appServiceThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ThreadStart</span><span class="token punctuation">(</span>ThreadProc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    appServiceThread<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    appServiceExit<span class="token punctuation">.</span><span class="token function">WaitOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The code above starts the execution of a method (called <code>ThreadProc</code>) in a separate thread. We use an <code>AutoResetEvent</code> to block the execution of the <code>Main()</code> method. This way, we make sure that the process will keep running until the communication channel created with the App Service is alive.</p>
<p>The <code>ThreadProc</code> method is the real &quot;core&quot; of the process, which takes care of initializing the connection with the App Service:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ThreadProc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span>AppServiceName <span class="token operator">=</span> <span class="token string">"RegistryService"</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span>PackageFamilyName <span class="token operator">=</span> Windows<span class="token punctuation">.</span>ApplicationModel<span class="token punctuation">.</span>Package<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>Id<span class="token punctuation">.</span>FamilyName<span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span>RequestReceived <span class="token operator">+=</span> Connection_RequestReceived<span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span>ServiceClosed <span class="token operator">+=</span> Connection_ServiceClosed<span class="token punctuation">;</span>

    <span class="token comment">//we open the connection</span>
    <span class="token class-name">AppServiceConnectionStatus</span> status <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">OpenAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> AppServiceConnectionStatus<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//if the connection fails, we terminate the Win32 process</span>
        appServiceExit<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We create a new <code>AppServiceConnection</code> and we configure it in the following way:</p>
<ul>
<li>We specify the name of the App Service we want to connect to, using the <code>AppServiceName</code> property. This name must match the one we're going to include inside the manifest of the Windows Application Packaging Project in a later stage.</li>
<li>We specify the Package Family Name of the application which hosts the App Service. In our scenario, since the React Native application and the classic Win32 process are hosted in the same package, we can retrieve it using the <code>Windows.ApplicationModel.Package</code> APIs.</li>
<li>We subscribe to two events: <code>RequestReceived</code>, which is triggered when the React Native application sends a message; <code>ServiceClosed</code>, which is triggered when the App Service channel is shut down.</li>
</ul>
<p>Then we use the <code>OpenAsync()</code> method to open the connection. If it isn't successful, there's no need for this process to stay alive, so we call <code>Set()</code> on the <code>AutoResetEvent</code> object, so that the <code>Main()</code> method can terminate.</p>
<p>Let's see now the implementation of the two event handlers. The first one, <code>ServiceClosed</code>, is the easiest one:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Connection_ServiceClosed</span><span class="token punctuation">(</span><span class="token class-name">AppServiceConnection</span> sender<span class="token punctuation">,</span> <span class="token class-name">AppServiceClosedEventArgs</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//when the connection with the App Service is closed, we terminate the Win32 process</span>
    appServiceExit<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>If the communication with the App Service drops, we simply call <code>Set()</code> on the <code>AutoResetEvent</code> object so that the process can terminate.</p>
<p>The second one, <code>RequestReceived</code>, instead, is the one where the communication with the React Native application happens:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Connection_RequestReceived</span><span class="token punctuation">(</span><span class="token class-name">AppServiceConnection</span> sender<span class="token punctuation">,</span> <span class="token class-name">AppServiceRequestReceivedEventArgs</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> key <span class="token operator">=</span> args<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Message<span class="token punctuation">[</span><span class="token string">"RegistryKeyName"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> hive <span class="token operator">=</span> Registry<span class="token punctuation">.</span>LocalMachine<span class="token punctuation">.</span><span class="token function">OpenSubKey</span><span class="token punctuation">(</span><span class="token string">@"SOFTWARE\Microsoft\Windows NT\CurrentVersion"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> hive<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ValueSet</span> valueSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ValueSet</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> <span class="token string">"RegistryKeyValue"</span><span class="token punctuation">,</span> <span class="token keyword">value</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> args<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">SendResponseAsync</span><span class="token punctuation">(</span>valueSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>From the <code>Request.Message</code> dictionary of the event arguments, we can retrieve any information passed by the main React Native application. In our scenario, the name of the requested registry key will be stored in an item with <code>RegistryKeyName</code> as key.
We use this information to connect to the registry (using the <code>Registry</code> APIs) and to retrieve this key from <code>SOFTWARE\Microsoft\Windows NT\CurrentVersion</code>, which is the hive that contains all the information about the currently installed version of Windows.</p>
<p>Once we have retrieved the key, we stored it a new message (the <code>ValueSet</code> object) with key <code>RegistryKeyValue</code>. In the end, we send it back using the <code>SendResponseAsync()</code> method, so that the caller (in our case, the native module) can use it.</p>
<h3><a class="anchor" aria-hidden="true" id="the-react-native-for-windows-application"></a><a href="#the-react-native-for-windows-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The React Native for Windows application</h3>
<p>When the classic Windows application invokes the <code>OpenAsync()</code> method to connect to the App Service, the host UWP app will wake up to respond (remember that we're using an in-proc App Service). This scenario is handled by a special event called <code>OnBackgroundActivated</code>, which you can subscribe in the <code>App</code> class of the host app. This is the implementation:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnBackgroundActivated</span><span class="token punctuation">(</span><span class="token class-name">BackgroundActivatedEventArgs</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnBackgroundActivated</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>TaskInstance<span class="token punctuation">.</span>TriggerDetails <span class="token keyword">is</span> <span class="token class-name">AppServiceTriggerDetails</span> details<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        appServiceDeferral <span class="token operator">=</span> args<span class="token punctuation">.</span>TaskInstance<span class="token punctuation">.</span><span class="token function">GetDeferral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> ns <span class="token operator">=</span> ReactPropertyBagHelper<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token string">"RegistryChannel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> ReactPropertyBagHelper<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">"AppServiceConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        InstanceSettings<span class="token punctuation">.</span>Properties<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> details<span class="token punctuation">.</span>AppServiceConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>First, we check if the type of activation is <code>AppServiceTriggerDetails</code>, since the application might have other background activation entry points. If that's the case we retrieve a deferral and we store it as a class variable:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">sealed</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ReactApplication</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">BackgroundTaskDeferral</span> appServiceDeferral<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The deferral is <a href="https://blogs.windows.com/windowsdeveloper/2016/04/28/the-lifecycle-of-a-uwp-app/">a concept used by the Universal Windows Platform</a> to properly handle asynchronous methods in background tasks. Since, when an asynchronous method is started, its execution is delegated to another thread, the background task might think that the operation is completed so Windows will terminate it. To avoid this scenario, we use a deferral to manually tell to the background task when the operation is really completed, by calling the <code>Complete()</code> method at the end. However, in our scenario, we just need to call <code>GetDeferral()</code> to get one, but we don't actually need to complete it, since we want our channel to stay alive until the application is running. If we don't do this, the channel would open, but it would be closed after a few seconds.</p>
<p>The last past of the code introduces a new concept, which are <strong>React Property Bags</strong>. This is a feature included in React Native which enables to share key / value pairs across an entire React Native application, including its modules. Why do we need it? Since we're building a React Native app, the UWP application won't contain the actual code which interacts with the App Service, but it will just host the JavaScript layer. As such, the communication will be handled by the native module. Thanks to React Property Bags, we can store a reference to the App Service in the host but let the native module use it.</p>
<p>The code creates a new property bag, which is composed by a namespace (<code>RegistryChannel</code>) and a name (<code>AppServiceConnection</code>). Then, using the <code>InstanceSettings</code> static class, we create the property bag in the current instance, by calling the <code>Set()</code> method and passing, as object to store, the App Service channel we have just created.</p>
<h3><a class="anchor" aria-hidden="true" id="the-native-module"></a><a href="#the-native-module" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The native module</h3>
<p>Now we are ready to interact with the classic Win32 process we have previously built. In a regular UWP scenario, we would have interacted with the App Service directly in the main application. However, in React Native for Windows, the UWP app is just a host for the JavaScript layer, so we need to build a native module to expose the APIs we need to JavaScript.</p>
<p>The next step is to add a native module to your solution. This is well documented in the <a href="https://microsoft.github.io/react-native-windows/docs/native-modules-setup">official documentation</a>. The module I'm going to build is a C# Windows Runtime Component, but of course you can do the same in C++.</p>
<p>By default, the module will contain two classes: one called <code>ReactPackageProvider</code>, which handles the registration in the main app, and one called <code>ReactNativeModule</code>, which contains the module definition. The default implementation of the class provided by the template will look like this:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">namespace</span> <span class="token namespace">ReactNativeAppServiceModule</span>
<span class="token punctuation">{</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReactModule</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"ReactNativeAppServiceModule"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">ReactNativeModule</span>
<span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ReactContext</span> _reactContext<span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReactInitializer</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token class-name">ReactContext</span> reactContext<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _reactContext <span class="token operator">=</span> reactContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReactMethod</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">sampleMethod</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> stringArgument<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> numberArgument<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO: Implement some actually useful functionality</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">"Received numberArgument: "</span> <span class="token operator">+</span> numberArgument <span class="token operator">+</span> <span class="token string">" stringArgument: "</span> <span class="token operator">+</span> stringArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The class already includes many elements we're going to need, like the <code>[ReactModule]</code> attribute to expose the module to JavaScript; the <code>[ReactMethod]</code> attribute to expose a method to JavaScript; the <code>[ReactInitializer]</code> attribute, which decorates the method that give us access to the <code>ReactContext</code> property. This is the object that will contain the property bag we have set in the main application.</p>
<p>Keep everything as it is, but delete the <code>sampleMethod()</code> function. We're going to replace it with the real methods that we need to expose to JavaScript.</p>
<p>Let's start with the first one:</p>
<pre><code class="hljs css language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReactMethod</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"launchFullTrustProcess"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">LaunchFullTrustProcessAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> FullTrustProcessLauncher<span class="token punctuation">.</span><span class="token function">LaunchFullTrustProcessForCurrentAppAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This method uses the <code>FullTrustProcessLauncher</code> API to launch a classic Win32 process from a UWP application. We just need to call it as it is. We're going to specify the information about the process to launch later in the manifest. Later, we're going to call this method from the JavaScript layer when the application starts.
By default, the <code>FullTrustProcessLauncher</code> class won't be found. The reason is that this API isn't included in UWP by default, but it's part of the specific extensions for desktop. As such, you have to right click on the native module's project, choose <strong>Add reference</strong> and, in the <strong>Universal Windows -&gt; Extensions</strong> section, click on the latest version of the <code>Windows Desktop Extension for UWP</code>.</p>
<p><img src="/react-native-windows/blog/assets/2021-05-08-win32component/desktop-extensions.png" alt="How to enable the Windows Desktop Extensions for UWP"></p>
<p>Let's see now the second method:</p>
<pre><code class="hljs css language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ReactMethod</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"getRegistryKey"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> <span class="token function">GetRegistryKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> ns <span class="token operator">=</span> ReactPropertyBagHelper<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token string">"RegistryChannel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> ReactPropertyBagHelper<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> <span class="token string">"AppServiceConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> content <span class="token operator">=</span> _reactContext<span class="token punctuation">.</span>Handle<span class="token punctuation">.</span>Properties<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> _connection <span class="token operator">=</span> content <span class="token keyword">as</span> <span class="token class-name">AppServiceConnection</span><span class="token punctuation">;</span>

    <span class="token class-name">ValueSet</span> valueSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ValueSet</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> <span class="token string">"RegistryKeyName"</span><span class="token punctuation">,</span> key <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> _connection<span class="token punctuation">.</span><span class="token function">SendMessageAsync</span><span class="token punctuation">(</span>valueSet<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">string</span></span> message <span class="token operator">=</span> result<span class="token punctuation">.</span>Message<span class="token punctuation">[</span><span class="token string">"RegistryKeyValue"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> message<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is the method that we'll invoke from the React Native application when we want to retrieve the value of a registry key. Through the <code>ReactContext</code> object we have retrieved in the initialization of the module, we can use the <code>Properties</code> collection to access to the property bags. We look for one called <code>AppServiceConnection</code> in the <code>RegistryChannel</code> namespace, which contains the reference to our App Service channel.
Once we have the channel, we can use it to send a message with the name of the key we want to retrieve (encapsulated in a <code>ValueSet</code> object) to the classic Win32 process using the <code>SendMessageAsync()</code> method. The message will be received by the Win32 process, which will retrieve the value of the requested key from the registry, and then it will send it back to our native module, as result of the <code>SendMessageAsync()</code> method. The response will be included in the <code>Message</code> collection with key <code>RegistryKeyValue</code>: we simply return this value to the JavaScript layer, so that the React Native app can display it.</p>
<p>There's one last step to do. Since we have manually created this module, we have also to manually register it in the main host application. As first step, right click on the host app, choose <strong>Add reference</strong> and select the native module. Then move to the <code>App</code> class and, in the constructor, add the following line before the <code>InitializeComponent()</code> method is invoked:</p>
<pre><code class="hljs css language-csharp">PackageProviders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReactNativeAppServiceModule<span class="token punctuation">.</span>ReactPackageProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>In case you have created the native module with a different name, make sure to replace <code>ReactNativeAppServiceModule</code> with the correct namespace.</p>
<h3><a class="anchor" aria-hidden="true" id="the-windows-application-packaging-project"></a><a href="#the-windows-application-packaging-project" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Windows Application Packaging Project</h3>
<p>The last step before we can try our solution is to add a Windows Application Packaging Project, which will help us to put together inside the same package the host UWP app and the classic Win32 process. Right click on the solution, choose <strong>Add -&gt; New project</strong> and look for the template called <strong>Windows Application Packaging Project</strong>. Once you have added it, right click on it and choose <strong>Add reference</strong>. Now you have to select two projects from your solution: the React Native host UWP app and the classic Win32 process. Once it's done, expand the <strong>Applications</strong> node, right click on the name of the host UWP app and choose <strong>Set as entry point</strong>. This will ensure that, when you click on the app icon in the Start menu, the main React Native app will be the one being launched.</p>
<p>Now we have to make a few changes to the manifest. One of the important differences you have to be aware when you introduce the Windows Application Packaging Project in a scenario like ours is that its manifest becomes the main one. As such, if you have previously customized the manifest of your host UWP app (for example, by adding assets for the icons, changing the identity or adding a few capabilities), you will have to port them in the manifest of the WAP project.
For this exact reason, make sure to make the following changes in the <code>Package.appxmanifest</code> file of the WAP project and not in the one of the host UWP app.</p>
<p>The first change is declaring the App Service. If you remember, previously in code we had to specify two information to connect to the App Service from the Win32 classic process: the name and the Package Family Name. The name is defined exactly in the manifest. Double click on the <strong>Package.appxmanifest</strong> file, move to the <strong>Declarations</strong> tab and, from the dropdown, choose <strong>App Service</strong> and click <strong>Add</strong>. The only required field is <strong>Name</strong>, which we have to fill with the same name that we have previously specified in code, which is <code>RegistryService</code>. Since it's an in-proc App Service, we don't have to specify any other information.</p>
<p><img src="/react-native-windows/blog/assets/2021-05-08-win32component/appservice-manifest.png" alt="How to declare an App Service in the manifest"></p>
<p>The second change is declaring which is the classic Win32 process that we want to launch when we use the <code>FullTrustLauncher</code> API. This feature isn't supported by the Visual Studio UI, so you'll have to right click on the <code>Package.appxmanifest</code> file and choose <strong>View code</strong>. You will find a section called <code>Extensions</code>, where the App Service has been declared. Exactly below, add the following entry:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Extensions</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">uap:Extension</span> <span class="hljs-attr">Category</span>=<span class="hljs-string">"windows.appService"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uap:AppService</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"RegistryService"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">uap:Extension</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">desktop:Extension</span> <span class="hljs-attr">Category</span>=<span class="hljs-string">"windows.fullTrustProcess"</span> <span class="hljs-attr">Executable</span>=<span class="hljs-string">"RegistryApp\RegistryApp.exe"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Extensions</span>&gt;</span>
</code></pre>
<p>The <code>Executable</code> attribute specifies the path of the classic Win32 process inside the package. By default, the WAP project puts all the build outputs inside a folder with the same name of the project. As such, our classic Win32 app will be available at the path <code>RegistryApp\RegistryApp.exe</code>.
To make this extension working, you will have also to declare the <code>desktop</code> namespace at the top, since it isn't included by default:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Package</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://schemas.microsoft.com/appx/manifest/foundation/windows10"</span>
  <span class="hljs-attr">xmlns:uap</span>=<span class="hljs-string">"http://schemas.microsoft.com/appx/manifest/uap/windows10"</span>
  <span class="hljs-attr">xmlns:desktop</span>=<span class="hljs-string">"http://schemas.microsoft.com/appx/manifest/desktop/windows10"</span>
  <span class="hljs-attr">IgnorableNamespaces</span>=<span class="hljs-string">"uap desktop"</span>&gt;</span>
</code></pre>
<p>The final change we would need to make is to add a capability called <strong>runFullTrust</strong>, which enables our package to include a classic Win32 component and not just a UWP application. However, the default manifest included in the WAP project already defines that. You can see it in the <code>Capabilities</code> section of the manifest:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Capabilities</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Capability</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"internetClient"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rescap:Capability</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"runFullTrust"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Capabilities</span>&gt;</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="the-react-native-application"></a><a href="#the-react-native-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The React Native application</h3>
<p>Finally, we now have all the pieces of the puzzle and we can start working on the JavaScript layer. As first step, we need to launch the classic Win32 process when the React Native application starts. If you're using a functional component, you can use the <code>useEffect</code> hook; if you're using a class component, you can use the <code>componentDidMount</code> event. In my case, I'm going for the first option, so I added in my application the following function:</p>
<pre><code class="hljs css language-javascript"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">launchProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> NativeModules<span class="token punctuation">.</span>ReactNativeAppServiceModule<span class="token punctuation">.</span><span class="token function">launchFullTrustProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">launchProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>If you have used native modules before, the code should be easy to understand. We use the <code>NativeModules</code> API in React to access to our native module, by specifying its name (<code>ReactNativeAppServiceModule</code>, which we have set using the <code>[ReactModule]</code> attribute) and the method (<code>launchFullTrustProcess()</code>, which we have set using the <code>[ReactMethod]</code> attribute).</p>
<p>The outcome is that, when you launch the main app from the Start menu, also the classic Win32 process will be launched. However, since it doesn't have any UI, it will run in background. You'll be able to see it using Task Manager:</p>
<p><img src="/react-native-windows/blog/assets/2021-05-08-win32component/registryapp.png" alt="The Win32 classic process running in background in Task Manager"></p>
<p>Now we need to store two information in the component's state: the name of the registry key we want to get (which will be filled by the user using a <code>TextInput</code> control) and its value, which will be returned by our native module. Since I'm using a functional component, I'm going to use the <code>useState</code> hook:</p>
<pre><code class="hljs css language-javascript"><span class="token keyword">const</span><span class="token punctuation">[</span>registryKeyName<span class="token punctuation">,</span> setRegistryKeyName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span><span class="token punctuation">[</span>registryKeyValue<span class="token punctuation">,</span> setRegistryKeyValue<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Now let's define the function that will invoke the native module to get the registry key and will store the result in the state:</p>
<pre><code class="hljs css language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">getRegistryKey</span> <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> NativeModules<span class="token punctuation">.</span>ReactNativeAppServiceModule<span class="token punctuation">.</span><span class="token function">getRegistryKey</span><span class="token punctuation">(</span>registryKeyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setRegistryKeyValue</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The approach is the same as the previous one: the only difference is that, this time, we're invoking the <code>getRegistryKey()</code> function, which requires as parameter the name of the key we want to retrieve from the <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion</code> hive.</p>
<p>Now let's build a minimal UI: a <code>TextInput</code> control, which will read the name of the registry key and store it in the state; a <code>Button</code>, which will invoke the <code>getRegistryKey()</code> function; a <code>Text</code>, which will display the value returned by the function.</p>
<pre><code class="hljs css language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">View</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TextInput</span></span> <span class="token attr-name">onChangeText</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token parameter">text</span> <span class="token operator">=></span> <span class="token function">setRegistryKeyName</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Get registry key<span class="token punctuation">"</span></span> <span class="token attr-name">onPress</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>getRegistryKey<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Text</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>registryKeyValue<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Text</span></span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">View</span></span><span class="token punctuation">></span></span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="running-the-app"></a><a href="#running-the-app" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running the app</h3>
<p>We're ready to test our work! First, go to Visual Studio, right click on the Windows Application Packaging Project and choose Deploy. You might get the following error:</p>
<pre><code class="hljs css language-plaintext">Error Task 'AddProjectMetadata' failed. The expression "[MSBuild]::MakeRelative(C:\ReactCSharp, *Undefined*)" cannot be evaluated. Illegal characters in path. C:\ReactCSharp\node_modules\react-native-windows\PropertySheets\Autolink.props
ReactCSharp.Package C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Microsoft\DesktopBridge\Microsoft.DesktopBridge.targets 408 
Error MSB4184 The expression "[MSBuild]::MakeRelative(C:\ReactCSharp, *Undefined*)" cannot be evaluated. Illegal characters in path. C:\ReactCSharp\node_modules\react-native-windows\PropertySheets\Autolink.props ReactCSharp.Package C:\ReactCSharp\node_modules\react-native-windows\PropertySheets\Autolink.props 12
</code></pre>
<p>If that's a case, this is a known issue that has already been addressed, but the fix isn't available yet in the latest stable React Native for Windows version. However, the workaround is easy. Open the file in the path <code>node_modules\react-native-windows\PropertySheets\Autolink.props</code> and replace the following line:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AutolinkCommandArgs</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(AutolinkCommandArgs)' == '' And '$(SolutionPath)' != '' And '$(ProjectPath)' != ''"</span>&gt;</span>--check --sln $([MSBuild]::MakeRelative($(AutolinkCommandWorkingDir), $(SolutionPath))) --proj $([MSBuild]::MakeRelative($(AutolinkCommandWorkingDir), $(ProjectPath)))<span class="hljs-tag">&lt;/<span class="hljs-name">AutolinkCommandArgs</span>&gt;</span>
</code></pre>
<p>with</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AutolinkCommandArgs</span> <span class="hljs-attr">Condition</span>=<span class="hljs-string">"'$(AutolinkCommandArgs)' == '' And '$(SolutionPath)' != '' And '$(SolutionPath)' != '*Undefined*' And '$(ProjectPath)' != ''"</span>&gt;</span>--check --sln $([MSBuild]::MakeRelative($(AutolinkCommandWorkingDir), $(SolutionPath))) --proj $([MSBuild]::MakeRelative($(AutolinkCommandWorkingDir), $(ProjectPath)))<span class="hljs-tag">&lt;/<span class="hljs-name">AutolinkCommandArgs</span>&gt;</span>
</code></pre>
<p>If you're building the project for the first time, it will take a while. Once it's deployed, you will find two entries in the Start menu: one for the base host app (for example, <code>appservicedemo</code>) and one for the WAP project (for example, <code>appservicedemo.Package</code>). Don't worry, when you will generate a MSIX package for release this won't happen anymore. However, if you want to remove this confusion also while you're debugging, just go back to Visual Studio, choose <strong>Build -&gt; Configuration Manager</strong> and make sure that the <strong>Deploy</strong> flag is turned on only for the WAP project.</p>
<p><img src="/react-native-windows/blog/assets/2021-05-08-win32component/defaultproject.png" alt="The Visual Studio configuration to deploy only the WAP project"></p>
<p>Before clicking on the Start menu entry for the WAP project, make sure to open a terminal on the folder which contains your project and run <code>yarn start</code> to launch the Metro packager.
If everything went well, the UI of the app should show up. Specify in the text box the name of one of the keys in the <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion</code> registry hive (for example, <code>BuildLab</code>) and press the button. If you did everything correctly, the value of the key will be displayed:</p>
<p><img src="/react-native-windows/blog/assets/2021-05-08-win32component/final-app.png" alt="The final application running"></p>
<p>If you want to create a package for release (to publish on the Microsoft Store or sideload on another machines), make sure to start the wizard (<strong>Publish --&gt; Create App Packages</strong>) from the WAP project and not from the host app, otherwise the classic Win32 process won't be included.</p>
<h3><a class="anchor" aria-hidden="true" id="conclusion"></a><a href="#conclusion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h3>
<p>It was a long journey, but now we have a React Native for Windows application which can interact with the Win32 ecosystem. In this article we built a sample scenario based on registry access, but the opportunities are unlimited! You can integrate SDKs which aren't supported by the Universal Windows Platform; or enhance your React Native application with features that otherwise won't be supported. You can find the sample project built for this article <a href="../../samples/AppServiceDemo">on GitHub</a>.</p>
<h3><a class="anchor" aria-hidden="true" id="credits"></a><a href="#credits" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Credits</h3>
<p>Icons used in the architecture:</p>
<ul>
<li><a href="https://iconscout.com/icons/react">React Flat Icon</a> by <a href="https://iconscout.com/contributors/icon-mafia">Icon Mafia</a></li>
<li><a href="https://iconscout.com/icons/windows">Windows Flat Logo Icon</a> <a href="https://iconscout.com/contributors/icon-mafia">Icon Mafia</a></li>
<li><a href="https://iconscout.com/icons/package">Package Colored Outline Icon</a> by <a href="https://iconscout.com/contributors/ferdizzimo">Vichanon Chaimsuk</a></li>
</ul>
</span></div></div><div class="blogSocialSection"></div></div><div class="blog-recent"><a class="button" href="/react-native-windows/blog/">Recent Posts</a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><div><h5>React Native Docs</h5><a href="https://reactnative.dev/docs/getting-started">Getting Started</a><a href="https://reactnative.dev/docs/tutorial">Tutorial</a><a href="https://reactnative.dev/docs/components-and-apis">Components and APIs</a><a href="https://reactnative.dev/docs/more-resources">More Resources</a></div><div><h5>React Native for Windows Docs</h5><div style="color:white;font-weight:500;font-size:16px"><a href="/react-native-windows/docs/getting-started">Get Started with Windows</a></div><a href="/react-native-windows/docs/parity-status">React Native Windows Components and APIs</a><a href="/react-native-windows/docs/native-modules">Native Modules</a><a href="/react-native-windows/docs/view-managers">Native UI Components</a></div><div><h5>Connect With Us On</h5><a href="https://devblogs.microsoft.com/react-native/">Blog</a><a href="https://twitter.com/ReactNativeMSFT" target="_blank">Twitter</a><a href="https://github.com/microsoft/react-native-windows" target="_blank">GitHub</a><a href="https://github.com/microsoft/react-native-windows-samples/tree/main/samples" target="_blank">Samples</a></div></section></footer></div></body></html>