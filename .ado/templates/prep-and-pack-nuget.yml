
steps:
  - task: DownloadBuildArtifacts@0
    displayName: 'Download debug arm Artifact'
    inputs:
      artifactName: ReactWindows-debug-arm
      downloadPath: $(System.DefaultWorkingDirectory)
  - task: DownloadBuildArtifacts@0
    displayName: 'Download ship arm Artifact'
    inputs:
      artifactName: ReactWindows-ship-arm
      downloadPath: $(System.DefaultWorkingDirectory)
  - task: DownloadBuildArtifacts@0
    displayName: 'Download debug x86 Artifact'
    inputs:
      artifactName: ReactWindows-debug-x86
      downloadPath: $(System.DefaultWorkingDirectory)
  - task: DownloadBuildArtifacts@0
    displayName: 'Download ship x86 Artifact'
    inputs:
      artifactName: ReactWindows-ship-x86
      downloadPath: $(System.DefaultWorkingDirectory)
  - task: DownloadBuildArtifacts@0
    displayName: 'Download debug x64 Artifact'
    inputs:
      artifactName: ReactWindows-debug-x64
      downloadPath: $(System.DefaultWorkingDirectory)
  - task: DownloadBuildArtifacts@0
    displayName: 'Download ship x64 Artifact'
    inputs:
      artifactName: ReactWindows-ship-x64
      downloadPath: $(System.DefaultWorkingDirectory)
  - task: DownloadBuildArtifacts@0
    displayName: 'Download source Artifact'
    inputs:
      artifactName: ReactWindows-source
      downloadPath: $(System.DefaultWorkingDirectory)

  - script: |
      rename $(System.DefaultWorkingDirectory)/ReactWindows-debug-x64 Debug
      robocopy $(System.DefaultWorkingDirectory)/Debug $(System.DefaultWorkingDirectory)/NugetRoot/target/x64 /E /MOV
      rename $(System.DefaultWorkingDirectory)/ReactWindows-debug-x86 Debug
      robocopy $(System.DefaultWorkingDirectory)/Debug $(System.DefaultWorkingDirectory)/NugetRoot/target/x86 /E /MOV
      rename $(System.DefaultWorkingDirectory)/ReactWindows-ship-x64 ship
      robocopy $(System.DefaultWorkingDirectory)/ship $(System.DefaultWorkingDirectory)/NugetRoot/target/x64 /E /MOV
      rename $(System.DefaultWorkingDirectory)/ReactWindows-ship-x86 ship
      robocopy $(System.DefaultWorkingDirectory)/ship $(System.DefaultWorkingDirectory)/NugetRoot/target/x86 /E /MOV
      rename $(System.DefaultWorkingDirectory)/ReactWindows-debug-arm debug
      robocopy $(System.DefaultWorkingDirectory)/debug $(System.DefaultWorkingDirectory)/NugetRoot/target/arm /E /MOV
      rename $(System.DefaultWorkingDirectory)/ReactWindows-ship-arm ship
      robocopy $(System.DefaultWorkingDirectory)/ship $(System.DefaultWorkingDirectory)/NugetRoot/target/arm /E /MOV
    displayName: Copy files from Artifact dirs to nuget staging

  - task: CopyFiles@2
    displayName: 'Copy Nuget source files'
    inputs:
      SourceFolder: '$(System.DefaultWorkingDirectory)/ReactWindows-source'
      TargetFolder: '$(System.DefaultWorkingDirectory)/NugetRoot'
  - task: PowerShell@2
    displayName: Extract version from package.json, and put it in nuspec
    inputs:
      targetType: inline # filePath | inline
      script: |
        if (Test-Path $env:SYSTEM_DEFAULTWORKINGDIRECTORY/UpdatedPackageJson/package.json) {
          $lines = Get-Content $env:SYSTEM_DEFAULTWORKINGDIRECTORY/UpdatedPackageJson/package.json | Where {$_ -match '^\s*"version":.*'} 
          $npmVersion = $lines.Trim().Split()[1].Trim('",');
        } else {
          $npmVersion = "0.0.1-pr"
        }
        (Get-Content $env:SYSTEM_DEFAULTWORKINGDIRECTORY/NugetRoot/ReactWin32.nuspec).replace('__BuildBuildNumber__', $npmVersion) | Set-Content $env:SYSTEM_DEFAULTWORKINGDIRECTORY/NugetRoot/ReactWin32.nuspec
        (Get-Content $env:SYSTEM_DEFAULTWORKINGDIRECTORY/NugetRoot/ReactUwp.nuspec).replace('__BuildBuildNumber__', $npmVersion) | Set-Content $env:SYSTEM_DEFAULTWORKINGDIRECTORY/NugetRoot/ReactUwp.nuspec
  - task: NuGetCommand@2
    displayName: 'NuGet pack'
    inputs:
      command: pack
      packagesToPack: '$(System.DefaultWorkingDirectory)/NugetRoot/React*.nuspec'
      packDestination: '$(System.DefaultWorkingDirectory)/NugetRoot/'