# Steps template for building any React Native Windows variant.

parameters:
  # NuGet & MSBuild
  project:
  msbuildVersion: $(MSBuildVersion)
  msBuildArchitecture: $(MSBuildArchitecture)
  preferredToolArchitecture: $(MSBuildPreferredToolArchitecture)
  platformToolset: $(MSBuildPlatformToolset)
  buildPlatform: x64
  buildConfiguration: Debug
  msbuildArguments: ''
  multicoreBuild: false
  warnAsError: true

variables:
  MSBuildArchitecture: x64
  MSBuildPreferredToolArchitecture: x64
  MSBuildPlatformToolset: v142
  TargetPlatformVersion: 10.0.19041.0

  ${if parameters.warnAsError }}:
    MsBuildWarnAsErrorArgument: /warnaserror
  ${if not(parameters.warnAsError) }}:
    MsBuildWarnAsErrorArgument: ''

steps:
  - powershell: |
      Write-Host "##vso[task.setvariable variable=BuildLogDirectory]$(Build.BinariesDirectory)\${{ parameters.buildPlatform }}\${{ parameters.buildConfiguration }}\BuildLogs"
    displayName: Set Log directory

  - template: prepare-build-env.yml

  - task: NuGetCommand@2
    displayName: NuGet restore
    inputs:
      command: restore
      restoreSolution: ${{parameters.project }}
      feedsToUse: config
      nugetConfigPath: $(Build.SourcesDirectory)/vnext/NuGet.config
      restoreDirectory: packages/
      verbosityRestore: Detailed # Options: quiet, normal, detailed

  - task: VSBuild@1
    displayName: VSBuild ${{parameters.project}}
    inputs:
      solution: ${{parameters.project}}
      vsVersion: ${{parameters.msbuildVersion}}
      msbuildArchitecture: ${{parameters.msBuildArchitecture}}
      platform: ${{ parameters.buildPlatform }}
      configuration: ${{ parameters.buildConfiguration }}
      clean: false # Optional
      maximumCpuCount: ${{ parameters.multicoreBuild }} # Optional
      restoreNugetPackages: false # Optional
      createLogFile: true
      logFileVerbosity: detailed
      msbuildArgs:
        /p:PreferredToolArchitecture=${{parameters.preferredToolArchitecture}}
        /p:PlatformToolset=${{parameters.platformToolset}}
        /p:PublishToolDuringBuild=true
        /p:EnableSourceLink=true
        /bl:$(BuildLogDirectory)\MsBuild.binlog
        /flp1:errorsonly;logfile=$(BuildLogDirectory)\MsBuild.err
        /flp2:warningsonly;logfile=$(BuildLogDirectory)\MsBuild.wrn
        /flp3:verbosity=diagnostic;logfile=$(BuildLogDirectory)\MsBuild.log        
        $(MsBuildWarnAsErrorArgument)
        ${{parameters.msbuildArguments}}

  - template: upload-build-logs.yml
    parameters:
      buildLogDirectory: $(BuildLogDirectory)
